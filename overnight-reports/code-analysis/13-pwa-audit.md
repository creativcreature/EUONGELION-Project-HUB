# PWA Audit

**Generated:** 2026-01-19
**Project:** EUONGELION
**Path:** `/Users/meltmac/Documents/Personal/wkGD/EUONGELION-STARTUP/app`

---

## Executive Summary

The EUONGELION app has a **comprehensive PWA setup** using `next-pwa` with extensive runtime caching, a well-configured manifest, and good offline support. The implementation follows modern PWA best practices but has a few gaps in offline UX and background sync capabilities.

**Overall Rating:** Very Good (8/10)

---

## 1. next.config.js PWA Configuration

**File:** `/app/next.config.js` (Lines 3-112)

### Configuration Analysis

```javascript
const withPWA = require('next-pwa')({
  dest: 'public',
  disable: process.env.NODE_ENV === 'development',  // Disabled in dev
  register: true,
  skipWaiting: true,
  runtimeCaching: [...],
});
```

### Runtime Caching Strategy

| Pattern | Handler | Cache Name | Max Age | Max Entries |
|---------|---------|------------|---------|-------------|
| Google Fonts | CacheFirst | `google-fonts` | 1 year | 10 |
| Font files (woff, etc.) | StaleWhileRevalidate | `static-font-assets` | 7 days | 10 |
| Images (jpg, png, webp) | StaleWhileRevalidate | `static-image-assets` | 30 days | 64 |
| Next.js images | StaleWhileRevalidate | `next-image` | 24 hours | 64 |
| JavaScript files | StaleWhileRevalidate | `static-js-assets` | 24 hours | 32 |
| CSS files | StaleWhileRevalidate | `static-style-assets` | 24 hours | 32 |
| Next.js data | StaleWhileRevalidate | `next-data` | 24 hours | 32 |
| API routes | NetworkFirst | `apis` | 24 hours | 16 |
| Everything else | NetworkFirst | `others` | 24 hours | 32 |

### Strengths
- Appropriate caching strategies per resource type
- Network timeout (10s) for API routes prevents hanging
- Long cache for fonts (rarely change)
- Reasonable max entries to prevent cache bloat

### Issues

1. **No offline fallback page** - When network fails and cache misses, user sees browser error
   - Missing: `offlineFallback` option in config

2. **API caching only for GET** - POST/PUT/DELETE requests not handled
   - Line 89: `method: 'GET'` restricts API caching

3. **No background sync** - Failed mutations aren't queued for retry

---

## 2. Manifest Configuration

**File:** `/app/public/manifest.json` (137 lines)

### Basic Configuration

| Field | Value | Status |
|-------|-------|--------|
| `name` | "EUONGELION - Daily Devotional" | Good |
| `short_name` | "EUONGELION" | Good |
| `start_url` | "/" | Good |
| `display` | "standalone" | Good |
| `background_color` | "#F7F3ED" | Good (parchment cream) |
| `theme_color` | "#1A1612" | Good (dark theme) |
| `orientation` | "portrait-primary" | Good for devotional reading |
| `scope` | "/" | Good |
| `lang` | "en" | Good |

### Icons

| Size | Purpose | Status |
|------|---------|--------|
| 72x72 | maskable any | |
| 96x96 | maskable any | |
| 128x128 | maskable any | |
| 144x144 | maskable any | |
| 152x152 | maskable any | |
| 192x192 | maskable any | Required for PWA |
| 384x384 | maskable any | |
| 512x512 | maskable any | Required for PWA |

**Note:** All icons use dual purpose `"maskable any"` which is good for compatibility but may result in suboptimal display on some devices. Consider separate maskable icons.

### Shortcuts (Lines 80-117)

```json
"shortcuts": [
  { "name": "Today's Devotional", "url": "/" },
  { "name": "Browse Series", "url": "/series" },
  { "name": "Soul Audit", "url": "/soul-audit" }
]
```

Good quick actions for user convenience.

### Screenshots (Lines 64-79)

Two screenshots configured for narrow (mobile) form factor:
- Home screen light mode
- Reader light mode

**Gap:** Missing wide (desktop) form factor screenshots.

### Share Target (Lines 124-133)

```json
"share_target": {
  "action": "/share",
  "method": "POST",
  "enctype": "multipart/form-data",
  "params": { "title": "title", "text": "text", "url": "url" }
}
```

**Issue:** No `/share` route exists to handle incoming shares.

### Advanced Features

| Feature | Status | Notes |
|---------|--------|-------|
| `handle_links` | "preferred" | Opens links in app |
| `launch_handler` | "navigate-existing" | Reuses existing window |
| `edge_side_panel` | 400px width | For Edge browser |
| `related_applications` | Empty | No native apps |

---

## 3. Service Worker Analysis

**File:** `/app/public/sw.js` (Generated by next-pwa)

The service worker is auto-generated and includes:

1. **Workbox precaching** - Static assets precached at install
2. **Runtime caching** - As configured in next.config.js
3. **Skip waiting** - Immediate activation of new SW
4. **Client claiming** - Takes control of all clients

### Precached Assets (from sw.js)

- Build manifest
- All JS chunks
- CSS files
- Font files
- Static pages

---

## 4. Offline Capabilities

### Current Implementation

**Hooks for offline:**
- `/hooks/useOfflineDevotionals.ts`
- `/hooks/useServiceWorker.ts`

**Components:**
- `/components/offline/OfflineIndicator.tsx`
- `/components/offline/OfflinePage.tsx`
- `/components/offline/CachedContent.tsx`

### useOfflineDevotionals Hook Analysis

From the console.log analysis, this hook provides:
- Cache refreshing
- Single devotional caching
- Multiple devotional caching
- Cache clearing
- Week prefetching

### Gaps in Offline Support

1. **No automatic offline detection in UI**
   - Need visual indicator when offline
   - Need graceful degradation

2. **No offline fallback page configured**
   - Add to next.config.js:
   ```javascript
   fallbacks: {
     document: '/offline',
   }
   ```

3. **No background sync for mutations**
   - Bookmarks, progress updates lost if offline

4. **No IndexedDB for large content**
   - Currently using localStorage via stores
   - IndexedDB storage exists in middleware but not used for content

---

## 5. Security Headers (from next.config.js)

**Lines 114-157** - Comprehensive security headers:

| Header | Value | Status |
|--------|-------|--------|
| X-DNS-Prefetch-Control | on | Good |
| HSTS | max-age=63072000; includeSubDomains; preload | Excellent |
| X-Content-Type-Options | nosniff | Good |
| X-Frame-Options | SAMEORIGIN | Good |
| X-XSS-Protection | 1; mode=block | Good |
| Referrer-Policy | strict-origin-when-cross-origin | Good |
| Permissions-Policy | Restricts sensitive APIs | Good |
| CSP | Comprehensive policy | Good |

### Content Security Policy Analysis

```
default-src 'self'
script-src 'self' 'unsafe-eval' 'unsafe-inline' + Google
style-src 'self' 'unsafe-inline' + Google Fonts
img-src 'self' data: blob: https:
font-src 'self' + Google Fonts
connect-src 'self' + Supabase + Analytics
frame-ancestors 'self' file:
```

**Note:** `'unsafe-eval'` and `'unsafe-inline'` are needed for Next.js but reduce security. Consider stricter CSP with nonces in future.

---

## 6. PWA Cache Headers (Lines 186-237)

| Path | Cache-Control | Status |
|------|---------------|--------|
| `/manifest.json` | `public, max-age=0, must-revalidate` | Good - always fresh |
| `/sw.js` | `public, max-age=0, must-revalidate` | Good - always check for updates |
| `/fonts/*` | `public, max-age=31536000, immutable` | Excellent |
| `/images/*` | `public, max-age=86400, stale-while-revalidate=31536000` | Good |

---

## 7. Push Notifications

### Implementation Found

- `/lib/notifications/push.ts`
- `/lib/notifications/subscription.ts`
- `/lib/notifications/permissions.ts`
- `/hooks/usePushNotifications.ts`

### Configuration

From `/lib/notifications/push.ts`:
```javascript
const vapidPublicKey = process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY;
const vapidPrivateKey = process.env.VAPID_PRIVATE_KEY;
const vapidSubject = process.env.VAPID_SUBJECT || 'mailto:admin@euongelion.com';
```

### Status

- VAPID keys required but not set in `.env.local`
- Push subscription management exists
- Permission handling implemented
- Server-side notification sending prepared

**Gap:** No actual notification scheduling/sending implementation visible.

---

## 8. Install Prompt

### Missing

No custom install prompt found in the codebase. Browser default will be used.

**Recommendation:** Add custom install prompt component:
- Detect `beforeinstallprompt` event
- Show contextual prompt (e.g., after first devotional read)
- Track install conversion

---

## 9. Action Items

### High Priority

1. **Add offline fallback page**
   ```javascript
   // next.config.js
   const withPWA = require('next-pwa')({
     // ... existing config
     fallbacks: {
       document: '/offline',
     },
   });
   ```
   - Create `/app/offline/page.tsx`

2. **Create /share route handler**
   - File: `/app/share/page.tsx`
   - Handle incoming share target requests

3. **Add online/offline indicator**
   - Show toast or banner when offline
   - Graceful UI degradation

### Medium Priority

4. **Implement background sync**
   - Queue failed POST/PUT requests
   - Sync when back online

5. **Add custom install prompt**
   - Create `InstallPrompt` component
   - Show at strategic moments

6. **Set up VAPID keys**
   - Generate keys: `npx web-push generate-vapid-keys`
   - Add to environment variables

7. **Separate maskable icons**
   - Create dedicated maskable icon with safe zone
   - Update manifest with separate icons

### Low Priority

8. **Add wide form factor screenshots**
   - Create desktop screenshots
   - Add to manifest

9. **Implement periodic background sync**
   - Prefetch today's devotional
   - Update cached content

10. **Add app badge support**
    - Show unread count on app icon
    - Use Badge API

---

## 10. Lighthouse PWA Checklist

| Requirement | Status | Notes |
|-------------|--------|-------|
| HTTPS | Assumed | Vercel default |
| Manifest linked | Yes | In layout.tsx |
| 192x192 icon | Yes | |
| 512x512 icon | Yes | |
| Start URL | Yes | "/" |
| Service Worker | Yes | Auto-generated |
| Offline fallback | No | Missing |
| Theme color | Yes | Dark theme |
| Viewport meta | Yes | In layout.tsx |
| Apple touch icon | Yes | In metadata |
| Maskable icon | Yes | All icons |

---

## Summary

The PWA implementation is solid with:
- Comprehensive runtime caching
- Well-configured manifest with shortcuts
- Security headers in place
- Push notification infrastructure ready

Key gaps to address:
1. **Offline fallback page** - Critical for user experience
2. **Share target route** - Manifest declares it but route missing
3. **Custom install prompt** - Improve installation rate
4. **Background sync** - Prevent data loss when offline

The app is installable and functional but needs offline UX improvements to be a truly great PWA.
